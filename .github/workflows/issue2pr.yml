name: Convert issue to PR
on:
  issues:
    types: [opened, edited, labeled]
jobs:
  long-format-issue-to-pr-nb:
    if: contains(github.event.issue.labels.*.name, 'nb') && contains(github.event.issue.labels.*.name, 'recipe') && contains(github.event.issue.labels.*.name, 'long-format')
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Parse issue
        id: parse
        uses: onmax/issue-form-parser@v1.5
        with:
          issue_number: ${{ github.event.issue.number }}
      - name: Set up environment variables
        run: |
          echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "ISSUEUSER=$(curl -s ${{ github.event.issue.user.url }} | jq -r '.name')" >> $GITHUB_ENV
          echo "ISSUEUSER_ID=$(curl -s ${{ github.event.issue.user.url }} | jq -r '.id')" >> $GITHUB_ENV
          if [[ "${{ fromJson(steps.parse.outputs.payload).Opphavsnavn }}" == "" ]]; then
            echo "CREATOR=$ISSUEUSER" >> $GITHUB_ENV
          else
            echo "CREATOR=${{ fromJson(steps.parse.outputs.payload).Opphavsnavn }}" >> $GITHUB_ENV
          fi
          if [[ "${{ fromJson(steps.parse.outputs.payload).Lenke }}" == "" ]]; then
            echo "CREATORURL=${{ github.event.issue.html_url }}" >> $GITHUB_ENV
          else
            echo "CREATORURL=${{ fromJson(steps.parse.outputs.payload).Lenke }}" >> $GITHUB_ENV
          fi
          echo "FILENAME=${{ fromJson(steps.parse.outputs.payload).Filnavn }}" >> $GITHUB_ENV
          echo "TMPDIR=/tmp/src/${{ fromJson(steps.parse.outputs.payload).Kategori }}" >> $GITHUB_ENV
          echo "TMPFILE=/tmp/src/${{ fromJson(steps.parse.outputs.payload).Kategori }}/${{ fromJson(steps.parse.outputs.payload).Oppskriftsnavn }}.md" >> $GITHUB_ENV
          echo "FILE_REL_TO_ROOT=src/${{ fromJson(steps.parse.outputs.payload).Kategori }}/${{ fromJson(steps.parse.outputs.payload).Oppskriftsnavn }}.md" >> $GITHUB_ENV
      - name: Download and convert cover image
        run: |
          # Install webp tools
          sudo apt-get update && sudo apt-get install -y webp

          # Extract image URL from Bilde field (format: ![...](URL) or just URL)
          BILDE_FIELD="${{ fromJson(steps.parse.outputs.payload).Bilde }}"
          if [[ -n "$BILDE_FIELD" ]]; then
            # Extract URL from markdown image syntax or use as-is
            IMAGE_URL=$(echo "$BILDE_FIELD" | grep -oP 'https://[^)>\s]+' | head -1)
            if [[ -n "$IMAGE_URL" ]]; then
              echo "Downloading image from: $IMAGE_URL"
              mkdir -p "src/Attachments/${{ env.FILENAME }}"
              # Download image
              curl -L -o /tmp/cover_image "$IMAGE_URL"
              # Convert to webp
              cwebp -q 80 /tmp/cover_image -o "src/Attachments/${{ env.FILENAME }}/${{ env.FILENAME }}.webp"
              echo "HAS_IMAGE=true" >> $GITHUB_ENV
            else
              echo "No valid image URL found"
              echo "HAS_IMAGE=false" >> $GITHUB_ENV
            fi
          else
            echo "No image provided"
            echo "HAS_IMAGE=false" >> $GITHUB_ENV
          fi
      - name: Create recipe
        run: |
          mkdir -p "$TMPDIR"
          touch "$TMPFILE"

          # Build tags array from Emner
          TAGS=""
          for tag in ${{ join(fromJson(steps.parse.outputs.payload).Emner, ' ') }}
          do
              TAGS="${TAGS}  - ${tag}\n"
          done

          # Build ingredients array with wiki-links
          INGREDIENTS_FM=""
          while IFS= read -r ingredient; do
              # Extract ingredient name (remove quantity)
              name=$(echo "$ingredient" | sed -E 's/^[0-9.,/]+\s*(g|kg|dl|l|ml|ss|ts|stk|pk|neve|klype)?\s*//i' | sed 's/^[[:space:]]*//')
              # Capitalize first letter
              name="$(echo "${name:0:1}" | tr '[:lower:]' '[:upper:]')${name:1}"
              INGREDIENTS_FM="${INGREDIENTS_FM}  - \"[[${name}]]\"\n"
          done < <(echo "${{ fromJson(steps.parse.outputs.payload).Ingredienser }}")

          # Write frontmatter
          cat << EOF > "$TMPFILE"
          ---
          description: "${{ fromJson(steps.parse.outputs.payload).Tid[2] }} | ${{ fromJson(steps.parse.outputs.payload).Vanskelighetsgrad }}"
          tags:
          $(echo -e "$TAGS")category:
            - ${{ fromJson(steps.parse.outputs.payload).Kategori }}
          authors:
            - "[[${CREATOR}]]"
          ingredients:
          $(echo -e "$INGREDIENTS_FM")---

          # ${{ fromJson(steps.parse.outputs.payload).Oppskriftsnavn }}

          ![](Attachments/${{ env.FILENAME }}/${{ env.FILENAME }}.webp)

          EOF

          # Add source callout if creator info exists
          if [[ "${{ fromJson(steps.parse.outputs.payload).Opphavsnavn }}" != "" ]] && [[ "${{ fromJson(steps.parse.outputs.payload).Lenke }}" != "" ]]; then
          cat << EOF >> "$TMPFILE"
          > [!NOTE]
          >
          > [Denne oppskriften](${{ fromJson(steps.parse.outputs.payload).Lenke }})
          > er originalt fra [[${{ fromJson(steps.parse.outputs.payload).Opphavsnavn }}]].

          EOF
          elif [[ "${{ fromJson(steps.parse.outputs.payload).Opphavsnavn }}" != "" ]]; then
          cat << EOF >> "$TMPFILE"
          > [!NOTE]
          >
          > Denne oppskriften er originalt fra [[${{ fromJson(steps.parse.outputs.payload).Opphavsnavn }}]].

          EOF
          fi

          # Add info table
          cat << EOF >> "$TMPFILE"
          | ‚è≤Ô∏è Tid | üçΩÔ∏è Porsjoner | üë®‚Äçüç≥ Vanskelighetsgrad |
          | ------ | ------------ | -------------------- |
          | ${{ fromJson(steps.parse.outputs.payload).Tid[2] }} | ${{ fromJson(steps.parse.outputs.payload).Porsjoner }} | ${{ fromJson(steps.parse.outputs.payload).Vanskelighetsgrad }} |

          ## Ingredienser

          #ingredient

          EOF

          # Add ingredients as checkboxes
          while IFS= read -r ingredient; do
              echo "- [x] $ingredient" >> "$TMPFILE"
          done < <(echo "${{ fromJson(steps.parse.outputs.payload).Ingredienser }}")

          cat << EOF >> "$TMPFILE"

          ## Steg

          EOF

          # Add steps as numbered list
          count=1
          while IFS= read -r step; do
              echo "$count. $step" >> "$TMPFILE"
              ((count++))
          done < <(echo "${{ fromJson(steps.parse.outputs.payload).Steg }}")

          cat "$TMPFILE"
          mv "$TMPFILE" ./"$FILE_REL_TO_ROOT"
      - name: Update main branch
        run: |
          git pull --rebase
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: "${{ fromJson(steps.parse.outputs.payload).Filnavn }}"
          add-paths: |
            ${{ env.FILE_REL_TO_ROOT }}
            src/Attachments/${{ env.FILENAME }}/${{ env.FILENAME }}.webp
          delete-branch: true
          author: ${{ github.event.issue.user.login }} <${{ env.ISSUEUSER_ID }}+${{ github.event.issue.user.login }}@users.noreply.github.com>
          reviewers: ${{ github.repository_owner }}
          assignees: ${{ github.repository_owner }}
          title: "feat(recipe): ${{ fromJson(steps.parse.outputs.payload).Oppskriftsnavn }}"
          body: |
            :robot: Jeg lagde akkurat en PR for √• legge til ${{ fromJson(steps.parse.outputs.payload).Oppskriftsnavn }} p√• vegne av [@${{ github.event.issue.user.login }}](${{ github.event.issue.user.html_url }}).

            Resolves #${{ github.event.issue.number }}
          labels: |
            recipe
  url-issue-to-pr-nb:
    if: contains(github.event.issue.labels.*.name, 'nb') && contains(github.event.issue.labels.*.name, 'recipe') && contains(github.event.issue.labels.*.name, 'recipe-scrapers')
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Parse issue
        id: parse
        uses: onmax/issue-form-parser@v1.5
        with:
          issue_number: ${{ github.event.issue.number }}
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install scripts with mise
        id: scraper
        run: |
          curl https://mise.jdx.dev/install.sh | sh
          echo "$HOME/.local/share/mise/bin">> $GITHUB_PATH
          echo "$HOME/.local/share/mise/shims">> $GITHUB_PATH
          eval "$(mise activate bash)"
          mise settings set experimental true
          mise run recipe-scrapers:install
          echo "PARSED=$(mise run recipe-scrapers:run ${{ fromJson(steps.parse.outputs.payload).Lenke }} | jq -c)" >> $GITHUB_ENV
      - name: Set up environment variables
        run: |
          echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "ISSUEUSER=$(curl -s ${{ github.event.issue.user.url }} | jq -r '.name')" >> $GITHUB_ENV
          echo "ISSUEUSER_ID=$(curl -s ${{ github.event.issue.user.url }} | jq -r '.id')" >> $GITHUB_ENV
          if [[ "${{ fromJson(env.PARSED).author.name }}" == "" ]]; then
            echo "CREATOR=${{ env.ISSUEUSER }}" >> $GITHUB_ENV
          else
            echo "CREATOR=${{ fromJson(env.PARSED).author.name }}" >> $GITHUB_ENV
          fi
          if [[ "${{ fromJson(env.PARSED).author.name }}" == "" ]]; then
            echo "CREATORURL=${{ github.event.issue.html_url }}" >> $GITHUB_ENV
          else
            echo "CREATORURL=${{ fromJson(env.PARSED).author.url }}" >> $GITHUB_ENV
          fi
          CATEGORY=${{ fromJson(steps.parse.outputs.payload).Kategori }}
          PATTERN=${{ fromJson(env.PARSED).pattern }}
          echo "CATEGORY=$CATEGORY" >> $GITHUB_ENV
          echo "PATTERN=$PATTERN" >> $GITHUB_ENV
          echo "TMPDIR=/tmp/src/$CATEGORY" >> $GITHUB_ENV
          echo "TMPFILE=/tmp/src/$CATEGORY/$PATTERN.md" >> $GITHUB_ENV
          echo "FILE_REL_TO_ROOT=src/$CATEGORY/$PATTERN.md" >> $GITHUB_ENV
      - name: Download and convert cover image
        run: |
          # Install webp tools
          sudo apt-get update && sudo apt-get install -y webp

          mkdir -p "src/Attachments/${{ env.PATTERN }}"

          # First check if user provided an image in the issue
          BILDE_FIELD="${{ fromJson(steps.parse.outputs.payload).Bilde }}"
          if [[ -n "$BILDE_FIELD" ]]; then
            # Extract URL from markdown image syntax or use as-is
            IMAGE_URL=$(echo "$BILDE_FIELD" | grep -oP 'https://[^)>\s]+' | head -1)
            if [[ -n "$IMAGE_URL" ]]; then
              echo "Downloading user-provided image from: $IMAGE_URL"
              curl -L -o /tmp/cover_image "$IMAGE_URL"
              cwebp -q 80 /tmp/cover_image -o "src/Attachments/${{ env.PATTERN }}/${{ env.PATTERN }}.webp"
              echo "HAS_IMAGE=true" >> $GITHUB_ENV
              exit 0
            fi
          fi

          # Fall back to scraped image if available
          SCRAPED_IMAGE=$(echo "$PARSED" | jq -r '.image // empty')
          if [[ -n "$SCRAPED_IMAGE" ]]; then
            echo "Downloading scraped image from: $SCRAPED_IMAGE"
            curl -L -o /tmp/cover_image "$SCRAPED_IMAGE" || true
            if [[ -f /tmp/cover_image ]]; then
              cwebp -q 80 /tmp/cover_image -o "src/Attachments/${{ env.PATTERN }}/${{ env.PATTERN }}.webp" || true
              if [[ -f "src/Attachments/${{ env.PATTERN }}/${{ env.PATTERN }}.webp" ]]; then
                echo "HAS_IMAGE=true" >> $GITHUB_ENV
                exit 0
              fi
            fi
          fi

          echo "No image available"
          echo "HAS_IMAGE=false" >> $GITHUB_ENV
      - name: Create recipe
        run: |
          mkdir -p "$TMPDIR"
          touch "$TMPFILE"

          # Build tags array from Emner
          TAGS=""
          for tag in ${{ join(fromJson(steps.parse.outputs.payload).Emner, ' ') }}
          do
              TAGS="${TAGS}  - ${tag}\n"
          done

          # Build ingredients array with wiki-links from scraped data
          INGREDIENTS_FM=""
          while IFS= read -r ingredient; do
              # Extract ingredient name (remove quantity)
              name=$(echo "$ingredient" | sed -E 's/^[0-9.,/]+\s*(g|kg|dl|l|ml|ss|ts|stk|pk|neve|klype)?\s*//i' | sed 's/^[[:space:]]*//')
              # Capitalize first letter
              name="$(echo "${name:0:1}" | tr '[:lower:]' '[:upper:]')${name:1}"
              INGREDIENTS_FM="${INGREDIENTS_FM}  - \"[[${name}]]\"\n"
          done < <(echo "$PARSED" | jq -r '.recipeIngredient[]')

          # Write frontmatter
          cat << EOF > "$TMPFILE"
          ---
          description: "${{ fromJson(env.PARSED).totalTime }} | ${{ fromJson(steps.parse.outputs.payload).Vanskelighetsgrad }}"
          tags:
          $(echo -e "$TAGS")category:
            - $CATEGORY
          authors:
            - "[[${CREATOR}]]"
          ingredients:
          $(echo -e "$INGREDIENTS_FM")---

          # ${{ fromJson(env.PARSED).name }}

          ![](Attachments/${{ env.PATTERN }}/${{ env.PATTERN }}.webp)

          EOF

          # Add source callout if author info exists
          if [[ "${{ fromJson(env.PARSED).author.name }}" != "" ]] && [[ "${{ fromJson(steps.parse.outputs.payload).Lenke }}" != "" ]]; then
          cat << EOF >> "$TMPFILE"
          > [!NOTE]
          >
          > [Denne oppskriften](${{ fromJson(steps.parse.outputs.payload).Lenke }})
          > er originalt fra [[${CREATOR}]].

          EOF
          elif [[ "${{ fromJson(env.PARSED).author.name }}" != "" ]]; then
          cat << EOF >> "$TMPFILE"
          > [!NOTE]
          >
          > Denne oppskriften er originalt fra [[${CREATOR}]].

          EOF
          fi

          # Add info table
          cat << EOF >> "$TMPFILE"
          | ‚è≤Ô∏è Tid | üçΩÔ∏è Porsjoner | üë®‚Äçüç≥ Vanskelighetsgrad |
          | ------ | ------------ | -------------------- |
          | ${{ fromJson(env.PARSED).totalTime }} | ${{ fromJson(env.PARSED).recipeYield }} | ${{ fromJson(steps.parse.outputs.payload).Vanskelighetsgrad }} |

          ## Ingredienser

          #ingredient

          EOF

          # Add ingredients as checkboxes from scraped data
          while IFS= read -r ingredient; do
              echo "- [x] $ingredient" >> "$TMPFILE"
          done < <(echo "$PARSED" | jq -r '.recipeIngredient[]')

          cat << EOF >> "$TMPFILE"

          ## Steg

          EOF

          # Add steps as numbered list from scraped data
          count=1
          while IFS= read -r step; do
              echo "$count. $step" >> "$TMPFILE"
              ((count++))
          done < <(echo "$PARSED" | jq -r '.recipeInstructions[].text')

          cat "$TMPFILE"
          mv "$TMPFILE" ./"$FILE_REL_TO_ROOT"
      - name: Update main branch
        run: |
          git pull --rebase
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: "${{ env.PATTERN }}"
          add-paths: |
            ${{ env.FILE_REL_TO_ROOT }}
            src/Attachments/${{ env.PATTERN }}/${{ env.PATTERN }}.webp
          delete-branch: true
          author: ${{ github.event.issue.user.login }} <${{ env.ISSUEUSER_ID }}+${{ github.event.issue.user.login }}@users.noreply.github.com>
          reviewers: ${{ github.repository_owner }}
          assignees: ${{ github.repository_owner }}
          title: "feat(recipe): ${{ fromJson(env.PARSED).name }}"
          body: |
            :robot: Jeg lagde akkurat en PR for √• legge til ${{ fromJson(env.PARSED).name }} p√• vegne av [@${{ github.event.issue.user.login }}](${{ github.event.issue.user.html_url }}).

            Resolves #${{ github.event.issue.number }}
          labels: |
            recipe
